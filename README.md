# üåô Kimi OpenAI-Compatible Proxy

A lightweight proxy server that makes **Moonshot AI's Kimi K2.5** work seamlessly with OpenAI-compatible clients like **VS Code Copilot Chat**, **BrowserOS**, and other IDE integrations.

## ‚ú® Why This Exists

Moonshot AI's Kimi K2.5 is a powerful reasoning model, but it has specific requirements that break compatibility with standard OpenAI clients:

1. **Fixed parameters**: Kimi K2.5 requires specific `temperature`, `top_p`, `n`, `presence_penalty`, and `frequency_penalty` values
2. **Required `reasoning_content`**: When thinking is enabled (default for K2.5), ALL assistant messages need a `reasoning_content` field
3. **Tool ID sanitization**: Some clients send tool call IDs with characters that Kimi's API rejects

This proxy sits between your OpenAI-compatible client and Moonshot's API, automatically fixing these issues.

## üöÄ Quick Start

### Prerequisites

- Node.js (v14 or higher)
- A Moonshot AI API key from [platform.moonshot.cn](https://platform.moonshot.cn)

### Installation

1. Clone or download this repository
2. Navigate to the proxy folder:
   ```bash
   cd kimi-openai-proxy
   ```
3. Start the proxy:
   ```bash
   node kimi-proxy.js
   ```

The proxy will start on `http://localhost:3001`.

## üîß Configuration

### VS Code Copilot Chat

1. Install an extension that allows custom OpenAI endpoints (like "ChatGPT" or "Continue")
2. Configure the base URL to: `http://localhost:3001/v1`
3. Set your API key to your Moonshot API key
4. Use model name: `kimi-k2.5`

Example settings for Continue extension:

```json
{
  "models": [
    {
      "name": "Kimi",
      "vendor": "customoai",
      // This apiKey format is auto-generated by VSCode when adding via "Manage Models" page
      // The group name "Kimi" and API key are assigned through that UI
      "apiKey": "${input:chat.lm.secret.-3f3c5984}",
      "models": [
        {
          "id": "kimi-k2.5",
          "name": "Kimi K2.5",
          "url": "http://localhost:3001/v1",
          "toolCalling": true,
          "vision": true,
          "thinking": true,
          "maxInputTokens": 256000,
          "maxOutputTokens": 32768
        }
      ]
    }
  ]
}
```

### BrowserOS / Other Tools

Any tool that supports OpenAI-compatible endpoints:
- Base URL: `http://localhost:3001`
- Model: `kimi-k2.5` or any model containing "kimi" or "moonshot"
- API Key: Your Moonshot API key

## üõ†Ô∏è How It Works

When a request comes through the proxy, it automatically:

### 1. Fixes Parameters
```javascript
data.temperature = 1;
data.top_p = 0.95;
data.n = 1;
data.presence_penalty = 0.0;
data.frequency_penalty = 0.0;
```

### 2. Adds Required `reasoning_content`
Kimi K2.5 has thinking enabled by default. The API requires `reasoning_content` on:
- All assistant messages with tool calls
- All assistant messages when using a thinking model

The proxy adds a placeholder space (`' '`) if missing.

### 3. Sanitizes Tool IDs
Normalizes tool call IDs to only contain valid characters: `a-zA-Z0-9_-`

## üìã Supported Models

The proxy activates for any model name containing:
- `kimi` (case-insensitive)
- `moonshot` (case-insensitive)

Examples:
- `kimi-k2.5` ‚úÖ
- `kimi-k1.5` ‚úÖ
- `moonshot-v1-8k` ‚úÖ
- `gpt-4` ‚ùå (passes through unchanged)

## üîç Debugging

The proxy logs all modifications to the console:

```
[2026-01-31T12:00:00.000Z] Processing request for model: kimi-k2.5
[2026-01-31T12:00:00.000Z] Processing 8 messages, needsReasoningOnAllAssistant=true
  msg[0] role=system hasToolCalls=false hasFunctionCall=false hasToolBlocks=false has_reasoning_content=false
  msg[1] role=user hasToolCalls=false hasFunctionCall=false hasToolBlocks=false has_reasoning_content=false
  msg[2] role=assistant hasToolCalls=true hasFunctionCall=false hasToolBlocks=false has_reasoning_content=false
    -> Added reasoning_content=' ' to msg[2]
  msg[3] role=tool hasToolCalls=false hasFunctionCall=false hasToolBlocks=false has_reasoning_content=false
[2026-01-31T12:00:00.000Z] Patched request params for kimi-k2.5
```

## üåê Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `PORT` | Proxy server port | `3001` |
| `TARGET_HOST` | Moonshot API host | `api.moonshot.ai` |
| `DEBUG_KIMI_PROXY` | Enable verbose logging | `false` |

## üêõ Troubleshooting

### Error: "thinking is enabled but reasoning_content is missing"
- ‚úÖ This proxy fixes this automatically
- Make sure the proxy is running before making requests
- Check the logs to see which messages are being patched

### Error: "temperature must be 1"
- ‚úÖ This proxy sets temperature to 1 automatically
- Some clients override this; check your client settings

### Error: "Invalid tool call ID"
- ‚úÖ This proxy sanitizes tool IDs automatically
- If you still see this, check the logs for the problematic ID

## ü§ù Contributing

Found an issue with another OpenAI-compatible client? The proxy likely needs to handle another edge case:

1. Check the error message from Moonshot's API
2. Look at what the client is sending vs. what Kimi expects
3. Add a transform in `ensureReasoningContentForToolCalls()` or `sanitizeToolIds()`

Pull requests welcome!

## üìÑ License

MIT License - feel free to use this in your projects!

## üôè Acknowledgments

- Moonshot AI for the Kimi K2.5 model
- The OpenAI API specification that makes this proxy possible
- All the OpenAI-compatible tools that benefit from this workaround

---

**Made with ‚ù§Ô∏è for the AI developer community**
